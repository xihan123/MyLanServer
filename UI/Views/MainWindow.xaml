<Window x:Class="MyLanServer.UI.Views.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
        xmlns:local="clr-namespace:MyLanServer.UI.Converters"
        xmlns:vm="clr-namespace:MyLanServer.UI.ViewModels"
        xmlns:i="http://schemas.microsoft.com/xaml/behaviors"
        Style="{StaticResource MaterialDesignWindow}"
        TextElement.Foreground="{DynamicResource MaterialDesignBody}"
        TextElement.FontWeight="Regular"
        TextElement.FontSize="14"
        TextOptions.TextFormattingMode="Ideal"
        TextOptions.TextRenderingMode="Auto"
        FontFamily="{DynamicResource MaterialDesignFont}"
        Background="{DynamicResource MaterialDesignPaper}"
        Title="内网文件分发与收集工具" Height="800" Width="1200"
        WindowStartupLocation="CenterScreen"
        WindowStyle="SingleBorderWindow"
        AllowsTransparency="False"
        ResizeMode="CanResizeWithGrip"
        mc:Ignorable="d"
        d:DataContext="{d:DesignInstance Type=vm:MainViewModel, IsDesignTimeCreatable=False}">

    <WindowChrome.WindowChrome>
        <WindowChrome CaptionHeight="46" ResizeBorderThickness="6" CornerRadius="0" GlassFrameThickness="0,0,0,1"
                      UseAeroCaptionButtons="False" />
    </WindowChrome.WindowChrome>

    <Window.Resources>
        <!-- 转换器资源 -->
        <local:LimitConverter x:Key="LimitConverter" />
        <local:IsExpiredToVisibilityConverter x:Key="IsExpiredToVisibilityConverter" />
        <local:TaskHasConfigVisibilityConverter x:Key="TaskHasConfigVisibilityConverter" />
        <local:TaskTypeConverter x:Key="TaskTypeConverter" />
        <local:UtcToLocalConverter x:Key="UtcToLocalConverter" />
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter" />
        <local:InverseBooleanConverter x:Key="InverseBooleanConverter" />

        <!-- 窗口控制按钮样式 -->
        <Style x:Key="WindowControlButtonStyle" TargetType="Button" BasedOn="{StaticResource MaterialDesignIconButton}">
            <Setter Property="Width" Value="40" />
            <Setter Property="Height" Value="40" />
            <!-- 修复属性描述符缺失：使用附加属性语法 -->
            <Setter Property="WindowChrome.IsHitTestVisibleInChrome" Value="True" />
            <Setter Property="Foreground" Value="{DynamicResource MaterialDesignBody}" />
        </Style>

        <Style x:Key="CloseButtonStyle" TargetType="Button" BasedOn="{StaticResource WindowControlButtonStyle}">
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Foreground" Value="White" />
                    <Setter Property="Background" Value="#E81123" />
                </Trigger>
            </Style.Triggers>
        </Style>

        <!-- DataGrid 右键菜单 (修复逻辑与绑定) -->
        <ContextMenu x:Key="RowContextMenu" Style="{StaticResource MaterialDesignContextMenu}"
                     d:DataContext="{d:DesignInstance Type=vm:MainViewModel}">
            <!-- 
               Binding Trick: 
               PlacementTarget 是 DataGridRow。
               PlacementTarget.Tag 是我们绑定的 MainViewModel。
               PlacementTarget.DataContext 是行对应的 LanTask 数据。
            -->

            <MenuItem Header="编辑任务"
                      Command="{Binding Path=PlacementTarget.Tag.EditTaskCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}"
                      CommandParameter="{Binding PlacementTarget.DataContext, RelativeSource={RelativeSource AncestorType=ContextMenu}}">
                <MenuItem.Icon>
                    <materialDesign:PackIcon Kind="Pencil" />
                </MenuItem.Icon>
            </MenuItem>

            <MenuItem Header="复刻分发"
                      Command="{Binding Path=PlacementTarget.Tag.CopyTaskCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}"
                      CommandParameter="{Binding PlacementTarget.DataContext, RelativeSource={RelativeSource AncestorType=ContextMenu}}">
                <MenuItem.Icon>
                    <materialDesign:PackIcon Kind="ContentCopy" />
                </MenuItem.Icon>
            </MenuItem>

            <Separator />

            <MenuItem Header="打开文件夹"
                      Command="{Binding Path=PlacementTarget.Tag.OpenFolderCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}"
                      CommandParameter="{Binding PlacementTarget.DataContext, RelativeSource={RelativeSource AncestorType=ContextMenu}}">
                <MenuItem.Icon>
                    <materialDesign:PackIcon Kind="FolderOpen" />
                </MenuItem.Icon>
            </MenuItem>

            <MenuItem Header="打开提交列表"
                      Command="{Binding Path=PlacementTarget.Tag.ShowSubmissionsListCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}"
                      CommandParameter="{Binding PlacementTarget.DataContext, RelativeSource={RelativeSource AncestorType=ContextMenu}}">
                <MenuItem.Icon>
                    <materialDesign:PackIcon Kind="AccountMultiple" />
                </MenuItem.Icon>
            </MenuItem>

            <MenuItem Header="合并文件"
                      Command="{Binding Path=PlacementTarget.Tag.OpenMergeDialogCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}"
                      CommandParameter="{Binding PlacementTarget.DataContext, RelativeSource={RelativeSource AncestorType=ContextMenu}}">
                <MenuItem.Icon>
                    <materialDesign:PackIcon Kind="Merge" />
                </MenuItem.Icon>
            </MenuItem>

            <Separator />

            <MenuItem Header="复制下载链接"
                      Command="{Binding Path=PlacementTarget.Tag.CopyLinkCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}"
                      CommandParameter="{Binding PlacementTarget.DataContext, RelativeSource={RelativeSource AncestorType=ContextMenu}}">
                <MenuItem.Icon>
                    <materialDesign:PackIcon Kind="Link" />
                </MenuItem.Icon>
            </MenuItem>

            <MenuItem Header="打开网页"
                      Command="{Binding Path=PlacementTarget.Tag.OpenShareLinkCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}"
                      CommandParameter="{Binding PlacementTarget.DataContext, RelativeSource={RelativeSource AncestorType=ContextMenu}}">
                <MenuItem.Icon>
                    <materialDesign:PackIcon Kind="Web" />
                </MenuItem.Icon>
            </MenuItem>

            <Separator
                Visibility="{Binding PlacementTarget.DataContext, RelativeSource={RelativeSource AncestorType=ContextMenu}, Converter={StaticResource TaskHasConfigVisibilityConverter}}" />

            <!-- 1. 取消密码访问 (有密码时显示) -->
            <MenuItem Header="取消密码访问"
                      Command="{Binding Path=PlacementTarget.Tag.RemovePasswordCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}"
                      CommandParameter="{Binding PlacementTarget.DataContext, RelativeSource={RelativeSource AncestorType=ContextMenu}}"
                      Visibility="{Binding PlacementTarget.DataContext.PasswordHash, RelativeSource={RelativeSource AncestorType=ContextMenu}, Converter={StaticResource HasPasswordToVisibilityConverter}}">
                <MenuItem.Icon>
                    <materialDesign:PackIcon Kind="LockOpen" />
                </MenuItem.Icon>
            </MenuItem>

            <!-- 2. 取消提交上限 (有上限时显示) -->
            <MenuItem Header="取消提交上限"
                      Command="{Binding Path=PlacementTarget.Tag.RemoveLimitCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}"
                      CommandParameter="{Binding PlacementTarget.DataContext, RelativeSource={RelativeSource AncestorType=ContextMenu}}"
                      Visibility="{Binding PlacementTarget.DataContext.MaxLimit, RelativeSource={RelativeSource AncestorType=ContextMenu}, Converter={StaticResource HasLimitToVisibilityConverter}}">
                <MenuItem.Icon>
                    <!-- 修复: Unlimited 改为 Infinity -->
                    <materialDesign:PackIcon Kind="Infinity" />
                </MenuItem.Icon>
            </MenuItem>

            <!-- 3. 取消一次性限制 (是一次性时显示) -->
            <MenuItem Header="取消一次性限制"
                      Command="{Binding Path=PlacementTarget.Tag.RemoveOneTimeLimitCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}"
                      CommandParameter="{Binding PlacementTarget.DataContext, RelativeSource={RelativeSource AncestorType=ContextMenu}}"
                      Visibility="{Binding PlacementTarget.DataContext.IsOneTimeLink, RelativeSource={RelativeSource AncestorType=ContextMenu}, Converter={StaticResource BooleanToVisibilityConverter}}">
                <MenuItem.Icon>
                    <materialDesign:PackIcon Kind="Numeric1BoxMultipleOutline" />
                </MenuItem.Icon>
            </MenuItem>

            <Separator />

            <!-- 4. 过期时间操作 -->
            <!-- 延长/设置过期时间 (始终显示：如果是长期，则变成定期；如果是定期，则延长时间) -->
            <MenuItem Header="设置/延长过期时间"
                      ItemsSource="{Binding PlacementTarget.Tag.ExpiryQuickOptions,
                                            RelativeSource={RelativeSource AncestorType=ContextMenu}}">
                <MenuItem.Icon>
                    <materialDesign:PackIcon Kind="ClockPlusOutline" />
                </MenuItem.Icon>
                <MenuItem.ItemContainerStyle>
                    <Style TargetType="MenuItem">
                        <Setter Property="Header" Value="{Binding DisplayName}" />
                        <Setter Property="Command"
                                Value="{Binding PlacementTarget.Tag.AddExpiryDurationCommand,
                                               RelativeSource={RelativeSource AncestorType=ContextMenu}}" />
                        <Setter Property="CommandParameter" Value="{Binding CommandParameter}" />
                    </Style>
                </MenuItem.ItemContainerStyle>
            </MenuItem>

            <!-- 取消过期时间 (仅当有过期时间时显示) -->
            <MenuItem Header="取消过期 (设为长期)"
                      Command="{Binding Path=PlacementTarget.Tag.RemoveExpiryCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}"
                      CommandParameter="{Binding PlacementTarget.DataContext, RelativeSource={RelativeSource AncestorType=ContextMenu}}"
                      Visibility="{Binding PlacementTarget.DataContext.ExpiryDate, RelativeSource={RelativeSource AncestorType=ContextMenu}, Converter={StaticResource NullToVisibilityConverter}}">
                <MenuItem.Icon>
                    <materialDesign:PackIcon Kind="CalendarRemove" />
                </MenuItem.Icon>
            </MenuItem>

            <Separator />

            <MenuItem
                Command="{Binding Path=PlacementTarget.Tag.ToggleTaskActiveCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}"
                CommandParameter="{Binding PlacementTarget.DataContext, RelativeSource={RelativeSource AncestorType=ContextMenu}}"
                Header="{Binding PlacementTarget.DataContext.IsActive, RelativeSource={RelativeSource AncestorType=ContextMenu}, Converter={StaticResource BoolToStringConverter}, ConverterParameter='禁用任务|启用任务'}">
                <MenuItem.Icon>
                    <materialDesign:PackIcon
                        Kind="{Binding PlacementTarget.DataContext.IsActive, RelativeSource={RelativeSource AncestorType=ContextMenu}, Converter={StaticResource BoolToStringConverter}, ConverterParameter='Cancel|CheckCircle'}" />
                </MenuItem.Icon>
            </MenuItem>

            <Separator />

            <MenuItem Header="删除任务"
                      Command="{Binding Path=PlacementTarget.Tag.DeleteTaskCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}"
                      CommandParameter="{Binding PlacementTarget.DataContext, RelativeSource={RelativeSource AncestorType=ContextMenu}}"
                      Foreground="{DynamicResource MaterialDesignErrorBrush}">
                <MenuItem.Icon>
                    <materialDesign:PackIcon Kind="Delete" Foreground="{DynamicResource MaterialDesignErrorBrush}" />
                </MenuItem.Icon>
            </MenuItem>
        </ContextMenu>
    </Window.Resources>

    <!-- 主布局 -->
    <materialDesign:Card x:Name="MainCard" UniformCornerRadius="0" Margin="0"
                         materialDesign:ElevationAssist.Elevation="Dp0"
                         Background="{DynamicResource MaterialDesignPaper}" BorderThickness="0">
        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="*" />
                <RowDefinition Height="Auto" />
            </Grid.RowDefinitions>

            <!-- 0. 标题栏 -->
            <Grid Grid.Row="0" Height="46" Background="Transparent">
                <StackPanel Orientation="Horizontal" VerticalAlignment="Center" Margin="16,0,0,0">
                    <materialDesign:PackIcon Kind="LanConnect" VerticalAlignment="Center" Margin="0,0,8,0"
                                             Foreground="{DynamicResource MaterialDesignPrimary}" />
                    <TextBlock Text="内网文件分发与收集工具" VerticalAlignment="Center" FontWeight="Medium" />
                </StackPanel>

                <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" VerticalAlignment="Top">
                    <Button Style="{StaticResource WindowControlButtonStyle}" Click="MinimizeButton_Click"
                            ToolTip="最小化">
                        <materialDesign:PackIcon Kind="WindowMinimize" />
                    </Button>
                    <Button Style="{StaticResource WindowControlButtonStyle}" Click="MaximizeButton_Click"
                            ToolTip="最大化/还原">
                        <materialDesign:PackIcon Kind="WindowMaximize" />
                    </Button>
                    <Button Style="{StaticResource CloseButtonStyle}" Click="CloseButton_Click" ToolTip="关闭">
                        <materialDesign:PackIcon Kind="WindowClose" />
                    </Button>
                </StackPanel>
            </Grid>

            <!-- 1. 服务器控制 -->
            <Border Grid.Row="1" Margin="16,4,16,16" CornerRadius="12" BorderThickness="1"
                    BorderBrush="{DynamicResource MaterialDesignDivider}">
                <Border.Style>
                    <Style TargetType="Border">
                        <Setter Property="Background" Value="{DynamicResource MaterialDesignSurfaceContainerLow}" />
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding IsServerRunning}" Value="True">
                                <Setter Property="Background" Value="{DynamicResource MaterialDesignPrimaryContainer}" />
                                <Setter Property="BorderThickness" Value="0" />
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </Border.Style>

                <Grid Margin="16">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>

                    <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center">
                        <materialDesign:PackIcon Kind="ServerNetwork" Width="24" Height="24" Margin="0,0,12,0"
                                                 VerticalAlignment="Center">
                            <materialDesign:PackIcon.Style>
                                <Style TargetType="materialDesign:PackIcon">
                                    <Setter Property="Foreground" Value="{DynamicResource MaterialDesignBody}" />
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding IsServerRunning}" Value="True">
                                            <Setter Property="Foreground"
                                                    Value="{DynamicResource MaterialDesignOnPrimaryContainer}" />
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </materialDesign:PackIcon.Style>
                        </materialDesign:PackIcon>
                        <TextBlock Text="{Binding ServerStatusText}" FontSize="16" FontWeight="Bold"
                                   VerticalAlignment="Center">
                            <TextBlock.Style>
                                <Style TargetType="TextBlock">
                                    <Setter Property="Foreground" Value="{DynamicResource MaterialDesignBody}" />
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding IsServerRunning}" Value="True">
                                            <Setter Property="Foreground"
                                                    Value="{DynamicResource MaterialDesignOnPrimaryContainer}" />
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </TextBlock.Style>
                        </TextBlock>
                    </StackPanel>

                    <StackPanel Grid.Column="1" VerticalAlignment="Center" HorizontalAlignment="Center"
                                Orientation="Horizontal"
                                Visibility="{Binding IsServerRunning, Converter={StaticResource BooleanToVisibilityConverter}}">
                        <TextBlock Text="{Binding ServerUrl}" FontSize="16" FontFamily="Consolas, Courier New"
                                   VerticalAlignment="Center" Margin="0,0,8,0" />
                        <Button Style="{StaticResource MaterialDesignIconButton}" Height="24" Width="24"
                                ToolTip="复制地址"
                                Command="{Binding CopyServerUrlCommand}">
                            <materialDesign:PackIcon Kind="ContentCopy" Width="14" Height="14" />
                        </Button>
                    </StackPanel>

                    <StackPanel Grid.Column="2" Orientation="Horizontal" VerticalAlignment="Center">
                        <TextBox materialDesign:HintAssist.Hint="端口"
                                 Style="{StaticResource MaterialDesignOutlinedTextBox}"
                                 Text="{Binding Port, UpdateSourceTrigger=PropertyChanged}"
                                 PreviewTextInput="Port_PreviewTextInput"
                                 Width="80" Margin="0,0,12,0" Padding="8,6"
                                 VerticalAlignment="Center"
                                 IsEnabled="{Binding IsServerRunning, Converter={StaticResource InverseBooleanConverter}}" />

                        <Button Command="{Binding StartServerCommand}"
                                Style="{StaticResource MaterialDesignRaisedButton}"
                                Visibility="{Binding IsServerRunning, Converter={StaticResource InverseBooleanConverter}}"
                                Margin="4,0" Height="36">
                            <StackPanel Orientation="Horizontal">
                                <materialDesign:PackIcon Kind="Play" Margin="0,0,6,0" VerticalAlignment="Center" />
                                <TextBlock Text="启动" VerticalAlignment="Center" />
                            </StackPanel>
                        </Button>

                        <Button Command="{Binding StopServerCommand}"
                                Style="{StaticResource MaterialDesignOutlinedButton}"
                                Visibility="{Binding IsServerRunning, Converter={StaticResource BooleanToVisibilityConverter}}"
                                BorderBrush="{DynamicResource MaterialDesignError}"
                                Foreground="{DynamicResource MaterialDesignError}"
                                Margin="4,0" Height="36">
                            <StackPanel Orientation="Horizontal">
                                <materialDesign:PackIcon Kind="Stop" Margin="0,0,6,0" VerticalAlignment="Center" />
                                <TextBlock Text="停止" VerticalAlignment="Center" />
                            </StackPanel>
                        </Button>
                    </StackPanel>
                </Grid>
            </Border>

            <!-- 2. 工具栏 -->
            <Grid Grid.Row="2" Margin="16,0,16,8">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <StackPanel Orientation="Horizontal">
                    <Button Command="{Binding CreateNewTaskCommand}"
                            Style="{StaticResource MaterialDesignRaisedButton}"
                            Margin="0,0,8,0" Height="36">
                        <StackPanel Orientation="Horizontal">
                            <materialDesign:PackIcon Kind="Plus" Margin="0,0,6,0" VerticalAlignment="Center" />
                            <TextBlock Text="新建任务" />
                        </StackPanel>
                    </Button>

                    <Button Command="{Binding OpenDepartmentManagementCommand}"
                            Style="{StaticResource MaterialDesignRaisedButton}"
                            Margin="0,0,8,0" Height="36">
                        <StackPanel Orientation="Horizontal">
                            <materialDesign:PackIcon Kind="Domain" Margin="0,0,6,0" VerticalAlignment="Center" />
                            <TextBlock Text="部门管理" />
                        </StackPanel>
                    </Button>

                    <Button Command="{Binding OpenPersonManagementCommand}"
                            Style="{StaticResource MaterialDesignRaisedButton}"
                            Margin="0,0,8,0" Height="36">
                        <StackPanel Orientation="Horizontal">
                            <materialDesign:PackIcon Kind="AccountMultiple" Margin="0,0,6,0" VerticalAlignment="Center" />
                            <TextBlock Text="人员管理" />
                        </StackPanel>
                    </Button>

                    <Button Command="{Binding OpenMergeDialogCommand}"
                            Style="{StaticResource MaterialDesignRaisedButton}"
                            Margin="0,0,8,0" Height="36">
                        <StackPanel Orientation="Horizontal">
                            <materialDesign:PackIcon Kind="Merge" Margin="0,0,6,0" VerticalAlignment="Center" />
                            <TextBlock Text="文件合并" />
                        </StackPanel>
                    </Button>

                    <Button Command="{Binding LoadTasksCommand}"
                            Style="{StaticResource MaterialDesignOutlinedButton}"
                            Margin="0,0,8,0" Height="36">
                        <StackPanel Orientation="Horizontal">
                            <materialDesign:PackIcon Kind="Refresh" Margin="0,0,6,0" VerticalAlignment="Center" />
                            <TextBlock Text="刷新列表" />
                        </StackPanel>
                    </Button>
                </StackPanel>

                <StackPanel Grid.Column="1" Orientation="Horizontal" VerticalAlignment="Center">
                    <CheckBox IsChecked="{Binding AutoRefreshEnabled}"
                              Style="{StaticResource MaterialDesignCheckBox}"
                              Content="自动刷新" VerticalAlignment="Center" Margin="0,0,8,0" />
                    <TextBox materialDesign:HintAssist.Hint="秒"
                             Text="{Binding AutoRefreshInterval}" Width="40"
                             Height="36"
                             Style="{StaticResource MaterialDesignOutlinedTextBox}"
                             Padding="4,2"
                             VerticalAlignment="Center"
                             PreviewTextInput="Number_PreviewTextInput"
                             IsEnabled="{Binding AutoRefreshEnabled}" />

                    <TextBox Width="200" Margin="16,0,0,0"
                             Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}"
                             Style="{StaticResource MaterialDesignOutlinedTextBox}"
                             materialDesign:TextFieldAssist.HasClearButton="True"
                             materialDesign:HintAssist.Hint="搜索..."
                             Padding="8,6" Height="36"
                             VerticalAlignment="Center" />
                </StackPanel>
            </Grid>

            <!-- 3. 数据列表 -->
            <Grid Grid.Row="3" Margin="16,0,16,0">
                <DataGrid ItemsSource="{Binding Tasks}" SelectedItem="{Binding SelectedTask}"
                          AutoGenerateColumns="False" IsReadOnly="True" SelectionMode="Single"
                          HeadersVisibility="All"
                          GridLinesVisibility="Horizontal"
                          CanUserSortColumns="True"
                          Background="Transparent"
                          Style="{StaticResource MaterialDesignDataGrid}"
                          BorderThickness="1"
                          BorderBrush="{DynamicResource MaterialDesignDivider}">

                    <DataGrid.Resources>
                        <Style TargetType="DataGridCell" BasedOn="{StaticResource MaterialDesignDataGridCell}">
                            <Setter Property="Padding" Value="8,6" />
                            <Setter Property="BorderThickness" Value="0" />
                            <Setter Property="VerticalAlignment" Value="Center" />
                        </Style>
                    </DataGrid.Resources>

                    <DataGrid.RowStyle>
                        <Style TargetType="DataGridRow" BasedOn="{StaticResource MaterialDesignDataGridRow}">
                            <Setter Property="ContextMenu" Value="{StaticResource RowContextMenu}" />
                            <!-- 绑定 ViewModel 到 Tag (用于右键菜单) -->
                            <Setter Property="Tag"
                                    Value="{Binding DataContext, RelativeSource={RelativeSource AncestorType=Window}}" />
                            <EventSetter Event="MouseRightButtonDown" Handler="DataGridRow_MouseRightButtonDown" />
                            <EventSetter Event="MouseDoubleClick" Handler="DataGridRow_MouseDoubleClick" />
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding IsActive}" Value="False">
                                    <Setter Property="Opacity" Value="0.6" />
                                    <Setter Property="Foreground" Value="Gray" />
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </DataGrid.RowStyle>

                    <DataGrid.Columns>
                        <!-- 任务类型 -->
                        <DataGridTextColumn Header="类型"
                                            Binding="{Binding TaskType, Converter={StaticResource TaskTypeConverter}}"
                                            Width="80" />

                        <!-- ID -->
                        <DataGridTemplateColumn Header="ID" Width="130">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <TextBlock Text="{Binding Slug}" FontWeight="SemiBold"
                                               Cursor="Hand"
                                               Foreground="{DynamicResource MaterialDesignPrimary}">
                                        <TextBlock.Style>
                                            <Style TargetType="TextBlock">
                                                <Style.Triggers>
                                                    <Trigger Property="IsMouseOver" Value="True">
                                                        <Setter Property="TextDecorations" Value="Underline" />
                                                        <Setter Property="Opacity" Value="0.8" />
                                                    </Trigger>
                                                </Style.Triggers>
                                            </Style>
                                        </TextBlock.Style>
                                        <i:Interaction.Triggers>
                                            <i:EventTrigger EventName="MouseLeftButtonDown">
                                                <i:InvokeCommandAction
                                                    Command="{Binding DataContext.CopyLinkCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                    CommandParameter="{Binding}" />
                                            </i:EventTrigger>
                                        </i:Interaction.Triggers>
                                    </TextBlock>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>

                        <!-- 描述 -->
                        <DataGridTextColumn Header="标题" Binding="{Binding Title}" Width="*">
                            <DataGridTextColumn.ElementStyle>
                                <Style TargetType="TextBlock" BasedOn="{StaticResource {x:Type TextBlock}}">
                                    <Setter Property="ToolTip" Value="{Binding Description}" />
                                    <Setter Property="ToolTipService.ShowDuration" Value="5000" />
                                </Style>
                            </DataGridTextColumn.ElementStyle>
                        </DataGridTextColumn>

                        <!-- 提交数 -->
                        <DataGridTemplateColumn Header="提交数/限制" Width="120">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <StackPanel Orientation="Horizontal" VerticalAlignment="Center"
                                                Cursor="Hand"
                                                Background="Transparent">
                                        <i:Interaction.Triggers>
                                            <i:EventTrigger EventName="MouseLeftButtonDown">
                                                <i:InvokeCommandAction
                                                    Command="{Binding DataContext.ShowSubmissionsListCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                    CommandParameter="{Binding}" />
                                            </i:EventTrigger>
                                        </i:Interaction.Triggers>

                                        <TextBlock Text="{Binding CurrentCount, Mode=OneWay}" FontWeight="Bold"
                                                   Foreground="{DynamicResource MaterialDesignPrimary}">
                                            <TextBlock.Style>
                                                <Style TargetType="TextBlock">
                                                    <Style.Triggers>
                                                        <Trigger Property="IsMouseOver" Value="True">
                                                            <Setter Property="TextDecorations" Value="Underline" />
                                                            <Setter Property="Opacity" Value="0.8" />
                                                        </Trigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </TextBlock.Style>
                                        </TextBlock>
                                        <TextBlock Text="/" Margin="2,0,2,0" />
                                        <TextBlock Text="{Binding MaxLimit, Converter={StaticResource LimitConverter}}" />
                                    </StackPanel>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>

                        <!-- 属性配置 -->
                        <DataGridTemplateColumn Header="属性配置" Width="Auto">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate d:DataType="core:LanTask">
                                    <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                        <!-- 1. 密码访问 -->
                                        <Border Background="{DynamicResource MaterialDesignSecondaryContainer}"
                                                CornerRadius="4" Padding="6,2" Margin="0,0,6,0"
                                                Visibility="{Binding PasswordHash, Converter={StaticResource HasPasswordToVisibilityConverter}}">
                                            <TextBlock Text="密码访问" FontSize="11"
                                                       Foreground="{DynamicResource MaterialDesignOnSecondaryContainer}"
                                                       FontWeight="Medium" />
                                        </Border>

                                        <!-- 2. 一次性 -->
                                        <Border Background="{DynamicResource MaterialDesignTertiaryContainer}"
                                                CornerRadius="4" Padding="6,2" Margin="0,0,6,0"
                                                Visibility="{Binding IsOneTimeLink, Converter={StaticResource BooleanToVisibilityConverter}}">
                                            <TextBlock Text="一次性" FontSize="11"
                                                       Foreground="{DynamicResource MaterialDesignOnTertiaryContainer}"
                                                       FontWeight="Medium" />
                                        </Border>

                                        <!-- 3. 已过期 (红色高亮) -->
                                        <Border Background="{DynamicResource MaterialDesignErrorContainer}"
                                                CornerRadius="4" Padding="6,2" Margin="0,0,6,0"
                                                Visibility="{Binding ExpiryDate, Converter={StaticResource IsExpiredToVisibilityConverter}}">
                                            <TextBlock Text="已过期" FontSize="11"
                                                       Foreground="{DynamicResource MaterialDesignOnErrorContainer}"
                                                       FontWeight="Medium" />
                                        </Border>
                                    </StackPanel>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>

                        <!-- 过期时间 -->
                        <DataGridTextColumn Header="过期时间"
                                            Binding="{Binding ExpiryDate, StringFormat='yyyy-MM-dd HH:mm', TargetNullValue='长期有效'}"
                                            Width="140" />

                        <!-- 激活状态 (直接 CheckBox 交互) -->
                        <DataGridTemplateColumn Header="激活" Width="60">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <CheckBox IsChecked="{Binding IsActive, UpdateSourceTrigger=PropertyChanged}"
                                              Style="{StaticResource MaterialDesignCheckBox}"
                                              Command="{Binding DataContext.ToggleTaskActiveCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                              CommandParameter="{x:Null}"
                                              HorizontalAlignment="Center" VerticalAlignment="Center" />
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>

                        <!-- 创建时间 -->
                        <DataGridTextColumn Header="创建时间"
                                            Binding="{Binding CreatedAt, Converter={StaticResource UtcToLocalConverter}, StringFormat='yyyy-MM-dd HH:mm'}"
                                            Width="140" />
                    </DataGrid.Columns>
                </DataGrid>
            </Grid>

            <!-- 4. 底部状态栏 -->
            <Border Grid.Row="4" Margin="0,8,0,0" Padding="16,8"
                    Background="{DynamicResource MaterialDesignSurfaceContainerLow}"
                    CornerRadius="0">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>

                    <StackPanel Orientation="Horizontal">
                        <StackPanel Orientation="Horizontal" Margin="0,0,16,0">
                            <materialDesign:PackIcon Kind="FileDocumentMultipleOutline" VerticalAlignment="Center"
                                                     Margin="0,0,4,0" />
                            <TextBlock Text="{Binding TotalTasks, StringFormat='总任务: {0}'}" VerticalAlignment="Center" />
                        </StackPanel>
                        <StackPanel Orientation="Horizontal">
                            <materialDesign:PackIcon Kind="UploadOutline" VerticalAlignment="Center" Margin="0,0,4,0" />
                            <TextBlock Text="{Binding TotalSubmissions, StringFormat='总提交: {0}'}"
                                       VerticalAlignment="Center" />
                        </StackPanel>
                    </StackPanel>

                    <TextBlock Grid.Column="2" Text="{Binding StatusMessage}" VerticalAlignment="Center" Opacity="0.8" />
                </Grid>
            </Border>
        </Grid>
    </materialDesign:Card>
</Window>